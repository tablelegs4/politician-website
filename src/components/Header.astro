---
// ヘッダーコンポーネント（JSなし、details/summaryでSPメニュー実装）
import { THEME_IMAGES, getThemeFromUrl } from '../config/theme';

// URLパラメータからテーマを取得
const currentTheme = getThemeFromUrl(Astro.url);

// URLパラメータを保持する関数
const themeParam = Astro.url.searchParams.get('theme');
const themeQuery = themeParam ? `?theme=${themeParam}` : '';

// ベースパスを適用したパスを生成する関数
const baseUrl = import.meta.env.BASE_URL || '/';
const withBase = (path: string) => {
  if (path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//') || path.startsWith('#')) {
    return path;
  }
  const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${base}${cleanPath}${themeQuery}`;
};

// ナビゲーション項目の定義
// isExternal: true の場合はページ遷移（遷移アイコン表示）
// PC用ナビ項目
const navItemsPC = [
  { label: 'トップ', href: '/', isExternal: false },
  { label: '魂のメッセージ', href: '#message', isExternal: false },
  { label: '政策', href: '#policy', isExternal: false },
  { label: '活動報告', href: '#activity', isExternal: false },
  { label: 'プロフィール', href: '/profile/', isExternal: true },
  { label: 'お問い合わせ', href: '/contact/', isExternal: true },
  { label: 'プライバシーポリシー', href: '/privacy/', isExternal: true },
];

// SP用ナビ項目（全てTOPページ内のアンカーリンク、ページ遷移なし）
const navItemsSP = [
  { label: 'トップ', href: '#top', isExternal: false },
  { label: '魂のメッセージ', href: '#message', isExternal: false },
  { label: '政策', href: '#policy', isExternal: false },
  { label: 'プロフィール', href: '#profile', isExternal: false },
  { label: '活動報告', href: '#activity', isExternal: false },
  { label: 'よくある質問', href: '#faq', isExternal: false },
  { label: '応援する', href: '#support', isExternal: false },
];

---

<header class="site-header sticky top-0 z-[100] py-5 md:py-5 max-md:py-[0.3rem] bg-gradient-to-b from-[#054a96] to-[#032f5e] text-white shadow-[inset_0_-3px_0_0_#f5b500,0_2px_4px_rgba(0,0,0,0.1)]">
  <div class="container max-w-full max-md:pl-[5px]">
    <div class="header-inner flex justify-between items-center relative">
      <div class="header-left flex items-center">
        <div class="site-title text-[0.5rem] font-bold text-white">
          <a href={withBase('/')} class="no-underline text-inherit flex items-center">
            <img src={THEME_IMAGES[currentTheme].logo} alt="山田太郎" class="header-logo h-[60px] max-md:h-[65px] w-auto" />
          </a>
        </div>
        <img src={withBase('/images/common/kokusa/kokusa_banzai.png')} alt="コクサ" class="header-kokusa h-[120px] max-md:h-[80px] w-auto object-cover object-top ml-[10px] max-md:ml-0 -mb-[53px] max-md:-mb-[37px] max-md:z-[101]" style="clip-path: inset(0 0 30% 0);" />
      </div>

      <!-- SP用ハンバーガーメニュー -->
      <details class="nav-toggle md:hidden cursor-pointer select-none relative order-10 ml-auto" id="sp-menu">
        <summary aria-label="メニューを開く" class="text-xl text-white p-1 [&::-webkit-details-marker]:hidden list-none">☰</summary>
        <nav class="main-nav-sp absolute top-full right-0 bg-[#032f5e] p-4 rounded min-w-[200px] shadow-[0_10px_15px_-3px_rgba(0,0,0,0.1),0_4px_6px_-2px_rgba(0,0,0,0.05)] z-[200]" aria-label="メインナビゲーション">
          <ul class="list-none flex flex-col gap-0">
            {navItemsSP.map((item) => (
              <li>
                <a href={withBase(item.href)} class={`block py-3 px-4 border-b border-white/20 text-white hover:bg-white/10 hover:no-underline last:border-b-0 ${item.isExternal ? 'inline-flex items-center' : ''}`}>
                  {item.label}
                  {item.isExternal && <span class="text-[0.75em] ml-1 opacity-80" aria-hidden="true">↗</span>}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </details>
      <!-- メニュー外タップで閉じる用オーバーレイ -->
      <div class="menu-overlay hidden fixed top-0 left-0 w-full h-full z-[99] [details[open]~&]:max-md:block" id="menu-overlay"></div>

      <!-- PC用ナビはCSSで常時表示 -->
      <nav class="main-nav-pc max-md:hidden ml-auto" aria-label="メインナビゲーション">
        <ul class="list-none flex items-center gap-10">
          {navItemsPC.map((item) => (
            <li>
              <a href={withBase(item.href)} class={`text-white font-medium text-[1.0625rem] py-2 border-b-2 border-transparent hover:border-white hover:no-underline transition-all duration-200 ${item.isExternal ? 'inline-flex items-center' : ''}`}>
                {item.label}
                {item.isExternal && <span class="text-[0.75em] ml-1 opacity-80" aria-hidden="true">↗</span>}
              </a>
            </li>
          ))}
        </ul>
      </nav>

    </div>
  </div>
</header>

<script>
  // メニュー外タップで閉じる
  document.addEventListener('DOMContentLoaded', () => {
    const menu = document.getElementById('sp-menu');
    const overlay = document.getElementById('menu-overlay');

    if (overlay && menu) {
      overlay.addEventListener('click', () => {
        menu.removeAttribute('open');
      });
    }

    // メニュー内のリンククリックでメニューを閉じる
    if (menu) {
      const links = menu.querySelectorAll('a');
      links.forEach(link => {
        link.addEventListener('click', () => {
          menu.removeAttribute('open');
        });
      });
    }
  });
</script>
