---
// ヘッダーコンポーネント（JSなし、details/summaryでSPメニュー実装）
import { THEME_IMAGES, getThemeFromUrl } from '../config/theme';

// URLパラメータからテーマを取得
const currentTheme = getThemeFromUrl(Astro.url);

// URLパラメータを保持する関数
const themeParam = Astro.url.searchParams.get('theme');
const themeQuery = themeParam ? `?theme=${themeParam}` : '';

// ベースパスを適用したパスを生成する関数
const baseUrl = import.meta.env.BASE_URL || '/';
const withBase = (path: string) => {
  if (path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//') || path.startsWith('#')) {
    return path;
  }
  const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${base}${cleanPath}${themeQuery}`;
};

// ナビゲーション項目の定義
// isExternal: true の場合はページ遷移（遷移アイコン表示）
// PC用ナビ項目
const navItemsPC = [
  { label: 'トップ', href: '/', isExternal: false },
  { label: '政策', href: '#policy', isExternal: false },
  { label: '活動報告', href: '#activity', isExternal: false },
  { label: 'プロフィール', href: '/profile/', isExternal: true },
  { label: 'お問い合わせ', href: '/contact/', isExternal: true },
  { label: 'プライバシーポリシー', href: '/privacy/', isExternal: true },
];

// SP用ナビ項目（全てTOPページ内のアンカーリンク、ページ遷移なし）
const navItemsSP = [
  { label: 'トップ', href: '#top', isExternal: false },
  { label: '政策', href: '#policy', isExternal: false },
  { label: 'プロフィール', href: '#profile', isExternal: false },
  { label: '活動報告', href: '#activity', isExternal: false },
  { label: 'よくある質問', href: '#faq', isExternal: false },
  { label: '応援する', href: '#support', isExternal: false },
];

---

<header class="site-header">
  <div class="container">
    <div class="header-inner">
      <div class="header-left">
        <div class="site-title">
          <a href={withBase('/')}>
            <img src={THEME_IMAGES[currentTheme].logo} alt="山田太郎" class="header-logo" />
          </a>
        </div>
        <img src={withBase('/images/common/kokusa/kokusa_banzai.png')} alt="コクサ" class="header-kokusa" />
      </div>

      <!-- SP用ハンバーガーメニュー -->
      <details class="nav-toggle" id="sp-menu">
        <summary aria-label="メニューを開く">☰</summary>
        <nav class="main-nav" aria-label="メインナビゲーション">
          <ul>
            {navItemsSP.map((item) => (
              <li>
                <a href={withBase(item.href)} class={item.isExternal ? 'nav-external' : ''}>
                  {item.label}
                  {item.isExternal && <span class="external-icon" aria-hidden="true">↗</span>}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </details>
      <!-- メニュー外タップで閉じる用オーバーレイ -->
      <div class="menu-overlay" id="menu-overlay"></div>

      <!-- PC用ナビはCSSで常時表示 -->
      <nav class="main-nav" aria-label="メインナビゲーション">
        <ul>
          {navItemsPC.map((item) => (
            <li>
              <a href={withBase(item.href)} class={item.isExternal ? 'nav-external' : ''}>
                {item.label}
                {item.isExternal && <span class="external-icon" aria-hidden="true">↗</span>}
              </a>
            </li>
          ))}
        </ul>
      </nav>

    </div>
  </div>
</header>

<style>
  /* ===========================
     ヘッダー（SP/PC差別化）
     =========================== */
  .site-header {
    background: linear-gradient(180deg, #054a96 0%, #032f5e 100%);
    color: #fff;
    padding: 1.25rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: inset 0 -3px 0 0 #f5b500, 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .site-header .container {
    max-width: 100%;
  }

  .header-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* ヘッダー左側（ロゴ＋コクサ） */
  .header-left {
    display: flex;
    align-items: center;
  }

  .site-title {
    font-size: .5rem;
    font-weight: bold;
    color: #fff;
  }

  .site-title a {
    color: inherit;
    text-decoration: none;
    display: flex;
    align-items: center;
  }

  .header-logo {
    height: 60px;
    width: auto;
  }

  /* ヘッダーのコクサ画像 */
  .header-kokusa {
    height: 120px;
    width: auto;
    object-fit: cover;
    object-position: top;
    clip-path: inset(0 0 30% 0);
    margin-left: 10px;
    margin-bottom: -53px;
  }

  /* 外部リンクアイコン */
  .external-icon {
    font-size: 0.75em;
    margin-left: 0.25em;
    opacity: 0.8;
  }

  .nav-external {
    display: inline-flex;
    align-items: center;
  }

  /* メニュー外タップで閉じる用オーバーレイ */
  .menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 99;
  }

  /* SP用スタイル */
  @media (max-width: 767px) {
    .site-header {
      padding: 0.3rem 0;
    }
    .site-header .container {
      padding-left: 5px;
    }
    .header-logo {
      height: 65px;
    }
    .header-inner {
      position: relative;
    }
    .nav-toggle {
      order: 10;
      margin-left: auto;
    }
    .header-kokusa {
      height: 80px;
      margin-left: 0px;
      margin-bottom: -37px;
    }
    .nav-toggle[open] ~ .menu-overlay {
      display: block;
    }
  }

  /* SP: ハンバーガーメニュー（details/summary使用、JSなし） */
  @media (max-width: 767px) {
    /* SP: details外のPC用navを非表示 */
    .header-inner > .main-nav {
      display: none;
    }

    .nav-toggle {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .nav-toggle summary {
      list-style: none;
      font-size: 1.25rem;
      color: #fff;
      padding: 0.25rem;
    }

    .nav-toggle summary::-webkit-details-marker {
      display: none;
    }

    .nav-toggle[open] summary {
      margin-bottom: 0;
    }

    /* ドロップダウンメニュー */
    .nav-toggle .main-nav {
      position: absolute;
      top: 100%;
      right: 0;
      background: #032f5e;
      padding: 1rem;
      border-radius: 4px;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 200;
    }

    .nav-toggle .main-nav ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .nav-toggle .main-nav a {
      color: #fff;
      display: block;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .nav-toggle .main-nav li:last-child a {
      border-bottom: none;
    }

    .nav-toggle .main-nav a:hover {
      background: rgba(255, 255, 255, 0.1);
      text-decoration: none;
    }
  }

  /* PC: 常時表示ナビ */
  @media (min-width: 768px) {
    /* PC: details（ハンバーガー）を非表示 */
    .nav-toggle {
      display: none;
    }

    /* PC: ナビを右端に配置 */
    .header-inner > .main-nav {
      margin-left: auto;
    }

    .main-nav ul {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 2.5rem;
    }

    .main-nav a {
      color: #fff;
      font-weight: 500;
      font-size: 1.0625rem;
      padding: 0.5rem 0;
      border-bottom: 2px solid transparent;
      transition: border-color 0.2s;
    }

    .main-nav a:hover {
      border-bottom-color: #fff;
      text-decoration: none;
    }
  }
</style>

<script>
  // メニュー外タップで閉じる
  document.addEventListener('DOMContentLoaded', () => {
    const menu = document.getElementById('sp-menu');
    const overlay = document.getElementById('menu-overlay');

    if (overlay && menu) {
      overlay.addEventListener('click', () => {
        menu.removeAttribute('open');
      });
    }

    // メニュー内のリンククリックでメニューを閉じる
    if (menu) {
      const links = menu.querySelectorAll('a');
      links.forEach(link => {
        link.addEventListener('click', () => {
          menu.removeAttribute('open');
        });
      });
    }
  });
</script>
