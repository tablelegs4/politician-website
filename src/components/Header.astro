---
// ヘッダーコンポーネント（JSなし、details/summaryでSPメニュー実装）
import { THEME_IMAGES, getThemeFromUrl } from '../config/theme';

// URLパラメータからテーマを取得
const currentTheme = getThemeFromUrl(Astro.url);

// URLパラメータを保持する関数
const themeParam = Astro.url.searchParams.get('theme');
const themeQuery = themeParam ? `?theme=${themeParam}` : '';

// ベースパスを適用したパスを生成する関数
const baseUrl = import.meta.env.BASE_URL || '/';
const withBase = (path: string) => {
  if (path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//') || path.startsWith('#')) {
    return path;
  }
  const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${base}${cleanPath}${themeQuery}`;
};

// ナビゲーション項目の定義
// isExternal: true の場合はページ遷移（遷移アイコン表示）
// PC用ナビ項目
const navItemsPC = [
  { label: 'トップ', href: '/', isExternal: false },
  { label: '政策', href: '#policy', isExternal: false },
  { label: '活動報告', href: '#activity', isExternal: false },
  { label: 'プロフィール', href: '/profile/', isExternal: true },
  { label: 'お問い合わせ', href: '/contact/', isExternal: true },
  { label: 'プライバシーポリシー', href: '/privacy/', isExternal: true },
];

// SP用ナビ項目（全てTOPページ内のアンカーリンク、ページ遷移なし）
const navItemsSP = [
  { label: 'トップ', href: '#top', isExternal: false },
  { label: '政策', href: '#policy', isExternal: false },
  { label: 'プロフィール', href: '#profile', isExternal: false },
  { label: '活動報告', href: '#activity', isExternal: false },
  { label: 'よくある質問', href: '#faq', isExternal: false },
  { label: '応援する', href: '#support', isExternal: false },
];

---

<header class="site-header">
  <div class="container">
    <div class="header-inner">
      <div class="header-left">
        <div class="site-title">
          <a href={withBase('/')}>
            <img src={THEME_IMAGES[currentTheme].logo} alt="山田太郎" class="header-logo" />
          </a>
        </div>
        <img src={withBase('/images/common/kokusa/kokusa_banzai.png')} alt="コクサ" class="header-kokusa" />
      </div>

      <!-- SP用ハンバーガーメニュー -->
      <details class="nav-toggle" id="sp-menu">
        <summary aria-label="メニューを開く">☰</summary>
        <nav class="main-nav" aria-label="メインナビゲーション">
          <ul>
            {navItemsSP.map((item) => (
              <li>
                <a href={withBase(item.href)} class={item.isExternal ? 'nav-external' : ''}>
                  {item.label}
                  {item.isExternal && <span class="external-icon" aria-hidden="true">↗</span>}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </details>
      <!-- メニュー外タップで閉じる用オーバーレイ -->
      <div class="menu-overlay" id="menu-overlay"></div>

      <!-- PC用ナビはCSSで常時表示 -->
      <nav class="main-nav" aria-label="メインナビゲーション">
        <ul>
          {navItemsPC.map((item) => (
            <li>
              <a href={withBase(item.href)} class={item.isExternal ? 'nav-external' : ''}>
                {item.label}
                {item.isExternal && <span class="external-icon" aria-hidden="true">↗</span>}
              </a>
            </li>
          ))}
        </ul>
      </nav>

    </div>
  </div>
</header>

<style>
  /* ヘッダー左側（ロゴ＋コクサ） */
  .header-left {
    display: flex;
    align-items: center;
  }

  /* ヘッダーのコクサ画像 */
  .header-kokusa {
    height: 80px;
    width: auto;
    object-fit: cover;
    object-position: top;
    clip-path: inset(0 0 30% 0);
    margin-left: -10px;
    margin-bottom: -24px;
  }

  @media (max-width: 767px) {
    .header-kokusa {
      height: 50px;
      margin-left: 8px;
      margin-bottom: -15px;
    }
  }

  /* 外部リンクアイコン */
  .external-icon {
    font-size: 0.75em;
    margin-left: 0.25em;
    opacity: 0.8;
  }

  .nav-external {
    display: inline-flex;
    align-items: center;
  }

  /* メニュー外タップで閉じる用オーバーレイ */
  .menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 99;
  }

  @media (max-width: 767px) {
    .nav-toggle[open] ~ .menu-overlay {
      display: block;
    }
  }
</style>

<script>
  // メニュー外タップで閉じる
  document.addEventListener('DOMContentLoaded', () => {
    const menu = document.getElementById('sp-menu');
    const overlay = document.getElementById('menu-overlay');

    if (overlay && menu) {
      overlay.addEventListener('click', () => {
        menu.removeAttribute('open');
      });
    }

    // メニュー内のリンククリックでメニューを閉じる
    if (menu) {
      const links = menu.querySelectorAll('a');
      links.forEach(link => {
        link.addEventListener('click', () => {
          menu.removeAttribute('open');
        });
      });
    }
  });
</script>
