---
import { getCollection } from 'astro:content';
import { THEME_IMAGES } from '../../../config/theme';
import { getSiteConfig, getProfile } from '../../../utils/content';

// コンテンツ読み込み
const siteConfig = getSiteConfig();
const profile = getProfile();

// URLパラメータを保持する関数
const themeParam = Astro.url.searchParams.get('theme');
const themeQuery = themeParam ? `?theme=${themeParam}` : '';

// ベースパスを適用したパスを生成する関数
const baseUrl = import.meta.env.BASE_URL || '/';
const withBase = (path: string) => {
  if (path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//')) {
    return path;
  }
  const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${base}${cleanPath}${themeQuery}`;
};

// 最新活動報告3件を取得（activityがあればactivity、なければnewsを使用）
let latestActivities: any[] = [];
try {
  const allActivities = await getCollection('activity');
  latestActivities = allActivities
    .filter(entry => !entry.data.draft)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    .slice(0, 3);
} catch {
  // activityがない場合はnewsを使用
  const allNews = await getCollection('news');
  latestActivities = allNews
    .filter(entry => !entry.data.draft)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    .slice(0, 3);
}

// 日付フォーマット関数
const formatDate = (date: Date) => {
  return date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).replace(/\//g, '-');
};
---

<main>
  <!-- ヒーローセクション -->
  <section class="hero-section">
    <div class="hero-image-wrapper">
      <img src={THEME_IMAGES.default.hero} alt={siteConfig.hero.title} class="hero-image" />
      <div class="hero-overlay">
        <div class="hero-content">
          <h1 class="hero-title">{siteConfig.hero.title}</h1>
          <p class="hero-subtitle">{siteConfig.hero.subtitle}</p>
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <div class="two-column-layout">
      <!-- メインコンテンツ -->
      <div class="main-content">
        <section>
          <h2>{siteConfig.greeting.title}</h2>
          {siteConfig.greeting.message.split('\n\n').map((paragraph) => (
            <p>{paragraph}</p>
          ))}
        </section>

        <section class="mt-4">
          <h2>最新の活動報告</h2>
          {latestActivities.length > 0 ? (
            <ul class="news-list">
              {latestActivities.map((entry) => (
                <li class="news-item">
                  <a href={withBase(`/activity/${entry.id.replace('.md', '')}/`)} class="news-link">
                    <div class="news-date">{formatDate(entry.data.date)}</div>
                    <div class="news-title">{entry.data.title}</div>
                    <div class="news-description">{entry.data.description}</div>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p>現在、活動報告はありません。</p>
          )}
          <div class="mt-2">
            <a href={withBase('/activity/')} class="btn">活動報告一覧を見る</a>
          </div>
        </section>
      </div>

      <!-- サイドバー（PCのみ表示） -->
      <aside class="sidebar">
        <div class="sidebar-widget">
          <h3>プロフィール</h3>
          <p><strong>{profile.name}</strong></p>
          <p>{profile.shortBio}</p>
          <a href={withBase('/profile/')} class="btn mt-2" style="width: 100%;">詳しく見る</a>
        </div>

        <div class="sidebar-widget">
          <h3>{siteConfig.cta.primary.label}</h3>
          <p>ご意見・ご要望をお聞かせください。</p>
          <a href={withBase(siteConfig.cta.primary.url)} class="btn btn-secondary mt-2" style="width: 100%;">{siteConfig.cta.primary.label}</a>
        </div>
      </aside>
    </div>
  </div>
</main>
