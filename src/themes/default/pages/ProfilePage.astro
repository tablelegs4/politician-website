---
// デフォルトテーマのプロフィールページ（足立方式）
import { getProfile } from '../../../utils/content';

const profile = getProfile();

// アスタリスク囲みのテキストを強調表示に変換する関数
const formatWithEmphasis = (text: string) => {
  return text.replace(/\*([^*]+)\*/g, '<strong class="emphasis">$1</strong>');
};

// URLパラメータを保持する関数
const themeParam = Astro.url.searchParams.get('theme');
const themeQuery = themeParam ? `?theme=${themeParam}` : '';

// ベースパスを適用したパスを生成する関数
const baseUrl = import.meta.env.BASE_URL || '/';
const withBase = (path: string) => {
  if (path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//')) {
    return path;
  }
  const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${base}${cleanPath}${themeQuery}`;
};

// 画像パスにベースを適用
const withImageBase = (path: string) => {
  if (path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//')) {
    return path;
  }
  const base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
  const cleanPath = path.startsWith('/') ? path : `/${path}`;
  return `${base}${cleanPath}`;
};

// 経歴がセットされているか確認
const hasHistory = profile.history && profile.history.length > 0 && profile.history.some((h: any) => h.year || h.event);

// 実績がセットされているか確認
const hasAchievements = profile.achievements && profile.achievements.length > 0;
---

<main>
  <div class="container">
    <h1 class="page-title-with-kokusa">
      プロフィール
      <img src={withImageBase('/images/common/kokusa/kokusa_salute.png')} alt="" class="page-title-kokusa" />
    </h1>

    <!-- プロフィールヘッダー：二つ名 + 名前 + 写真 + 選挙区 -->
    <section class="profile-header">
      <div class="profile-header-content">
        {profile.nickname && <p class="profile-nickname" set:html={formatWithEmphasis(profile.nickname)} />}
        <h2 class="profile-fullname">
          {profile.nameReading && <ruby>{profile.name}<rp>(</rp><rt>{profile.nameReading}</rt><rp>)</rp></ruby>}
          {!profile.nameReading && profile.name}
        </h2>
        <div class="profile-header-image-wrapper">
          <img
            src={withImageBase(profile.photo)}
            alt={`${profile.name}のプロフィール写真`}
            class="profile-main-image"
            loading="eager"
          />
        </div>
        {profile.basicInfo?.electoralDistrict && profile.basicInfo.electoralDistrict.district && (
          <p class="profile-district">
            {profile.basicInfo.electoralDistrict.type && `${profile.basicInfo.electoralDistrict.type} `}
            {profile.basicInfo.electoralDistrict.term && `${profile.basicInfo.electoralDistrict.term}期 `}
            {profile.basicInfo.electoralDistrict.district}
            {profile.basicInfo.electoralDistrict.cities && profile.basicInfo.electoralDistrict.cities.length > 0 && (
              <span class="profile-cities">（{profile.basicInfo.electoralDistrict.cities.join('、')}）</span>
            )}
          </p>
        )}
      </div>
    </section>

    <!-- 基本情報 -->
    <section class="card">
      <h2 class="section-title-with-kokusa">
        基本情報
        <img src={withImageBase('/images/common/kokusa/kokusa_circle.png')} alt="" class="section-kokusa" />
      </h2>
      <div class="profile-info-list">
        <div class="profile-info-item">
          <div class="profile-info-label">氏名</div>
          <div class="profile-info-value">{profile.name}{profile.nameReading && `（${profile.nameReading}）`}</div>
        </div>
        {profile.basicInfo?.birthYear && (
          <div class="profile-info-item">
            <div class="profile-info-label">生年</div>
            <div class="profile-info-value">{profile.basicInfo.birthYear}</div>
          </div>
        )}
        {profile.basicInfo?.location && (
          <div class="profile-info-item">
            <div class="profile-info-label">{profile.basicInfo.locationType === 'residence' ? '現住所' : '出身地'}</div>
            <div class="profile-info-value">{profile.basicInfo.location}</div>
          </div>
        )}
        {profile.basicInfo?.electoralDistrict && profile.basicInfo.electoralDistrict.district && (
          <div class="profile-info-item">
            <div class="profile-info-label">選挙区</div>
            <div class="profile-info-value">
              {profile.basicInfo.electoralDistrict.type && `${profile.basicInfo.electoralDistrict.type} `}
              {profile.basicInfo.electoralDistrict.term && `${profile.basicInfo.electoralDistrict.term}期 `}
              {profile.basicInfo.electoralDistrict.district}
              {profile.basicInfo.electoralDistrict.cities && profile.basicInfo.electoralDistrict.cities.length > 0 && (
                <div class="district-cities">（{profile.basicInfo.electoralDistrict.cities.join('、')}）</div>
              )}
            </div>
          </div>
        )}
        {profile.personalInfo?.items && profile.personalInfo.items.length > 0 && profile.personalInfo.items.map((item: { title: string; content: string }) => (
          <div class="profile-info-item">
            <div class="profile-info-label">{item.title}</div>
            <div class="profile-info-value">{item.content}</div>
          </div>
        ))}
      </div>
    </section>

    <!-- 経歴 -->
    {hasHistory && (
      <section class="mt-4">
        <h2 class="section-title-with-kokusa">
          経歴
          <img src={withImageBase('/images/common/kokusa/kokusa_gaze.png')} alt="" class="section-kokusa" />
        </h2>
        <ul class="history-list">
          {profile.history.filter((h: any) => h.year || h.event).map((item: any) => (
            <li>
              {item.year && <span class="history-year">{item.year}</span>}
              {item.event}
            </li>
          ))}
        </ul>
      </section>
    )}

    <!-- 政治信条 -->
    {profile.politicalBelief && (
      <section class="mt-4">
        <h2 class="section-title-with-kokusa">
          政治信条
          <img src={withImageBase('/images/common/kokusa/kokusa_fistpump.png')} alt="" class="section-kokusa" />
        </h2>
        <div class="political-belief">
          {typeof profile.politicalBelief === 'string' ? (
            <p>{profile.politicalBelief}</p>
          ) : (
            <>
              <p class="political-belief-title">{profile.politicalBelief.title}</p>
              <p class="political-belief-detail">{profile.politicalBelief.detail}</p>
            </>
          )}
        </div>
      </section>
    )}

    <!-- 実績 -->
    {hasAchievements && (
      <section class="mt-4">
        <h2 class="section-title-with-kokusa">
          実績
          <img src={withImageBase('/images/common/kokusa/kokusa_thumbsup.png')} alt="" class="section-kokusa" />
        </h2>
        <ul class="achievements-list">
          {profile.achievements?.map((item: string) => (
            <li>{item}</li>
          ))}
        </ul>
      </section>
    )}

    <section class="mt-4 cta-with-kokusa">
      <img src={withImageBase('/images/common/kokusa/kokusa_bow.png')} alt="" class="cta-kokusa" />
      <div class="text-center">
        <a href={withBase('/policy/')} class="btn">政策を見る</a>
        <a href={withBase('/contact/')} class="btn btn-secondary" style="margin-left: 1rem;">お問い合わせ</a>
      </div>
    </section>
  </div>
</main>

<style>
  /* プロフィールヘッダー */
  .profile-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
  }

  .profile-header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0;
  }

  .profile-header-image-wrapper {
    width: 100%;
    overflow: hidden;
    margin: 0.5rem 0;
  }

  .profile-main-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .profile-nickname {
    font-size: 2rem;
    color: #000000;
    font-weight: 900;
    margin: 0;
    font-family: 'Noto Sans JP', "BIZ UDPGothic", "Hiragino Kaku Gothic Pro", "メイリオ", Meiryo, "ＭＳ Ｐゴシック", "MS PGothic", sans-serif;
    white-space: nowrap;
  }

  .profile-fullname {
    font-size: 3rem;
    color: #000000;
    margin: 0;
    border: none;
    padding: 0;
    font-weight: 900;
    font-family: 'Noto Sans JP', "BIZ UDPGothic", "Hiragino Kaku Gothic Pro", "メイリオ", Meiryo, "ＭＳ Ｐゴシック", "MS PGothic", sans-serif;
  }

  .profile-fullname rt {
    font-size: 0.5em;
    font-weight: normal;
    color: #666;
  }

  .profile-district {
    font-size: 0.9375rem;
    color: #000000;
    margin: 0 0 0.75rem;
    line-height: 1.6;
  }

  .profile-cities {
    display: block;
    font-size: 0.875rem;
    color: #000000;
    margin-top: 0.25rem;
  }

  @media (max-width: 600px) {
    .profile-header {
      padding: 1rem;
    }

    .profile-nickname {
      font-size: 2rem;
    }

    .profile-fullname {
      font-size: 3rem;
    }
  }

  /* 基本情報リスト（項目→改行→内容形式） */
  .profile-info-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .profile-info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .profile-info-label {
    font-weight: bold;
    color: #043e80;
    font-size: 1rem;
  }

  .profile-info-value {
    color: #333;
    font-size: 1rem;
    line-height: 1.6;
  }

  .district-cities {
    font-size: 0.875rem;
    color: #666;
  }

  /* 経歴 */
  .history-list {
    margin: 0;
    padding-left: 1.25rem;
    line-height: 2;
  }

  .history-year {
    font-weight: bold;
    color: #043e80;
    margin-right: 0.5rem;
  }

  /* 政治信条 */
  .political-belief {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #043e80;
  }

  .political-belief p {
    margin: 0;
    line-height: 1.8;
    color: #333;
  }

  .political-belief-title {
    font-family: "Yuji Syuku", "Zen Kurenaido", "Klee One", serif;
    font-size: 1.5rem;
    font-weight: bold;
    color: #043e80;
    margin-bottom: 0.75rem !important;
    line-height: 1.4;
  }

  .political-belief-detail {
    font-size: 1rem;
  }

  /* 実績 */
  .achievements-list {
    margin: 0;
    padding-left: 1.25rem;
    line-height: 2;
  }

  .achievements-list li {
    color: #333;
  }

  /* こくさキャラクター装飾 */
  .page-title-with-kokusa {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .page-title-kokusa {
    height: 3rem;
    width: auto;
  }

  .section-title-with-kokusa {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-kokusa {
    height: 2rem;
    width: auto;
  }

  .cta-with-kokusa {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
    background: #f8fafc;
    border-radius: 8px;
  }

  .cta-kokusa {
    height: 80px;
    width: auto;
  }

  @media (max-width: 600px) {
    .page-title-kokusa {
      height: 2.5rem;
    }

    .section-kokusa {
      height: 1.75rem;
    }

    .cta-kokusa {
      height: 60px;
    }
  }
</style>

<style is:global>
  /* 強調表示（アスタリスク囲み） */
  .emphasis {
    color: #c41e3a;
    font-weight: bold;
  }
</style>
